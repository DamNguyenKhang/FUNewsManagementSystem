@model FUNewsManagementSystemMVC.Models.UpdateNewsArticleViewModel
@{
    ViewData["Title"] = "Edit News Article";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var categories = ViewBag.Categories as IEnumerable<BusinessObject.Entities.Category>;
    var tags = ViewBag.Tags as IEnumerable<BusinessObject.Entities.Tag>;
}

<style>
    #editor:empty:before {
        content: attr(placeholder);
        color: #9ca3af;
        cursor: text;
    }
    #editor a {
        color: #f37120;
        text-decoration: underline;
    }
</style>

<!-- Synchronized Header -->
<header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
    <div class="flex items-center gap-2 text-sm">
        <span class="text-text-secondary">Admin</span>
        <span class="text-gray-300">/</span>
        <span class="text-text-secondary">Manage News</span>
        <span class="text-gray-300">/</span>
        <span class="font-medium text-gray-900">Edit Article</span>
    </div>
    <div class="flex items-center gap-4">
        <span class="material-symbols-outlined text-gray-400">notifications</span>
    </div>
</header>

<div class="p-6 md:p-8">
    <main class="w-full max-w-[1440px] mx-auto">
        <!-- Page Title -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-text-main tracking-tight font-display">Edit News Article</h1>
                <p class="text-text-secondary mt-1">Update article content as Administrator.</p>
            </div>
            <a asp-action="News" class="flex items-center gap-2 text-sm font-medium text-text-secondary hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-[20px]">arrow_back</span>
                Back to News Management
            </a>
        </div>

        <form asp-action="EditNews" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="NewsArticleId" />
            <div asp-validation-summary="ModelOnly" class="text-red-500 text-sm mb-4"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column: Main Editor -->
                <div class="lg:col-span-8 flex flex-col gap-6">
                    <!-- Title Input -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <label asp-for="NewsTitle" class="block text-sm font-semibold text-text-main mb-2">Article Headline</label>
                        <input asp-for="NewsTitle" class="w-full text-xl md:text-2xl font-bold text-text-main bg-transparent border-0 border-b-2 border-gray-100 focus:border-primary focus:ring-0 px-0 py-2 placeholder-gray-300 transition-colors" placeholder="Enter a catchy headline for your news article..." />
                        <span asp-validation-for="NewsTitle" class="text-red-500 text-xs mt-1"></span>
                    </div>

                    <!-- Rich Text Editor -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">
                        <!-- Toolbar -->
                        <div class="flex flex-wrap items-center gap-1 p-3 border-b border-gray-100 bg-gray-50/50">
                            <div class="flex items-center border-r border-gray-200 pr-2 mr-1">
                                <select onchange="formatDoc('formatBlock', this.value); this.selectedIndex=0;" class="text-sm bg-transparent border-none focus:ring-0 font-medium text-text-main cursor-pointer hover:bg-black/5 rounded px-2 py-1">
                                    <option value="" selected disabled>Format</option>
                                    <option value="p">Paragraph</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                </select>
                            </div>
                            <button id="btn-bold" type="button" onclick="formatDoc('bold')" class="p-1.5 text-text-secondary hover:text-primary hover:bg-primary/10 rounded transition-colors" title="Bold">
                                <span class="material-symbols-outlined text-[20px]">format_bold</span>
                            </button>
                            <button id="btn-italic" type="button" onclick="formatDoc('italic')" class="p-1.5 text-text-secondary hover:text-primary hover:bg-primary/10 rounded transition-colors" title="Italic">
                                <span class="material-symbols-outlined text-[20px]">format_italic</span>
                            </button>
                            <button id="btn-underline" type="button" onclick="formatDoc('underline')" class="p-1.5 text-text-secondary hover:text-primary hover:bg-primary/10 rounded transition-colors" title="Underline">
                                <span class="material-symbols-outlined text-[20px]">format_underlined</span>
                            </button>
                            <div class="w-px h-5 bg-gray-200 mx-1"></div>
                            <button type="button" onclick="createLink()" class="p-1.5 text-text-secondary hover:text-primary hover:bg-primary/10 rounded transition-colors" title="Link">
                                <span class="material-symbols-outlined text-[20px]">link</span>
                            </button>
                            <button type="button" onclick="const url = prompt('Enter the image URL'); if(url) formatDoc('insertImage', url)" class="p-1.5 text-text-secondary hover:text-primary hover:bg-primary/10 rounded transition-colors" title="Image">
                                <span class="material-symbols-outlined text-[20px]">image</span>
                            </button>
                            <button type="button" onclick="formatDoc('formatBlock', 'blockquote')" class="p-1.5 text-text-secondary hover:text-primary hover:bg-primary/10 rounded transition-colors" title="Quote">
                                <span class="material-symbols-outlined text-[20px]">format_quote</span>
                            </button>
                        </div>
                        <!-- Editable Area -->
                        <div id="editor" contenteditable="true" class="flex-1 w-full p-6 bg-transparent border-none focus:ring-0 text-base leading-relaxed text-text-main min-h-[400px] outline-none prose-sm sm:prose max-w-none" placeholder="Start writing your article content here..."></div>
                        <textarea asp-for="NewsContent" id="NewsContentHidden" style="display:none;"></textarea>
                        <span asp-validation-for="NewsContent" class="text-red-500 text-xs px-6 pb-2"></span>
                    </div>

                    <!-- Featured Image -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <label class="block text-sm font-semibold text-text-main mb-4">Featured Image</label>
                        
                        <div class="relative group">
                            <!-- Upload Box / Preview Area -->
                            <div id="imageContainer" class="border-2 border-dashed border-gray-200 rounded-xl overflow-hidden min-h-[250px] flex items-center justify-center bg-gray-50/50 transition-all">
                                <!-- Empty State -->
                                <div id="emptyState" onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center justify-center p-8 text-center cursor-pointer hover:bg-primary/5 transition-colors w-full h-full @(string.IsNullOrEmpty(Model.NewsArticleImage) ? "" : "hidden")">
                                    <div class="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                        <span class="material-symbols-outlined text-3xl text-primary">cloud_upload</span>
                                    </div>
                                    <p class="text-text-main font-bold">Click to upload or drag and drop</p>
                                    <p class="text-sm text-text-secondary mt-1">SVG, PNG, JPG or GIF (max. 800x400px)</p>
                                </div>

                                <!-- Preview State -->
                                <div id="previewState" class="relative w-full h-full min-h-[250px] @(string.IsNullOrEmpty(Model.NewsArticleImage) ? "hidden" : "")">
                                    <img id="imagePreview" src="@Model.NewsArticleImage" alt="Preview" class="w-full h-full object-cover" />
                                    <!-- Remove Button -->
                                    <button type="button" onclick="clearImage()" class="absolute top-4 right-4 h-10 w-10 bg-white/90 backdrop-blur rounded-full shadow-lg flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all z-10">
                                        <span class="material-symbols-outlined filled">close</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Hidden File Input -->
                            <input type="file" id="fileInput" name="ImageFile" accept="image/*" class="hidden" onchange="handleFileSelect(this)" />
                        </div>

                        <div class="mt-6 flex flex-col gap-2">
                             <div class="flex items-center gap-2">
                                <span class="h-px bg-gray-200 flex-1"></span>
                                <span class="text-[10px] font-bold text-text-secondary uppercase tracking-widest">Or use Image URL</span>
                                <span class="h-px bg-gray-200 flex-1"></span>
                             </div>
                             <div class="flex gap-2">
                                <span class="material-symbols-outlined text-gray-400 mt-2.5">link</span>
                                <input asp-for="NewsArticleImage" id="imageUrlInput" class="flex-1 rounded-lg border-gray-200 bg-gray-50 text-sm focus:border-primary focus:ring-primary py-2.5" placeholder="https://example.com/image.jpg" />
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Sidebar -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="sticky top-24 space-y-6">
                        <!-- Publish Settings Card -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-md overflow-hidden">
                            <div class="bg-gray-50 px-5 py-3 border-b border-gray-100 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-xl">settings</span>
                                <h3 class="font-semibold text-text-main">Publish Settings</h3>
                            </div>
                            <div class="p-5 space-y-6">
                                <!-- Headline Short Input -->
                                <div>
                                    <label asp-for="Headline" class="block text-sm font-medium text-text-main mb-2">Short Headline</label>
                                    <input asp-for="Headline" class="w-full rounded-lg border-gray-200 bg-gray-50 text-sm focus:border-primary focus:ring-primary py-2.5" placeholder="Summary for grid view..." />
                                    <span asp-validation-for="Headline" class="text-red-500 text-xs mt-1"></span>
                                </div>

                                <!-- Category -->
                                <div>
                                    <label asp-for="CategoryId" class="block text-sm font-medium text-text-main mb-2">Category</label>
                                    <select asp-for="CategoryId" class="w-full rounded-lg border-gray-200 bg-gray-50 text-text-main focus:border-primary focus:ring-primary text-sm py-2.5">
                                        <option value="">Select a category</option>
                                        @if (categories != null)
                                        {
                                            foreach (var cat in categories)
                                            {
                                                <option value="@cat.Id">@cat.CategoryName</option>
                                            }
                                        }
                                    </select>
                                    <span asp-validation-for="CategoryId" class="text-red-500 text-xs mt-1"></span>
                                </div>

                                <!-- Tags Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-text-main mb-2">Tags</label>
                                    <div class="p-2 bg-gray-50 border border-gray-200 rounded-lg focus-within:ring-1 focus-within:ring-primary focus-within:border-primary transition-all">
                                        <div id="selectedTagsContainer" class="flex flex-wrap gap-2 mb-2">
                                            <!-- Selected tags chips will go here -->
                                        </div>
                                        <input id="tagInput" class="w-full bg-transparent border-none p-0 text-sm focus:ring-0 placeholder-text-secondary" placeholder="Select tags below..." readonly type="text"/>
                                        <!-- Hidden inputs for form submission -->
                                        <div id="hiddenTagsInputs">
                                            @if (Model.TagIds != null)
                                            {
                                                foreach (var tagId in Model.TagIds)
                                                {
                                                    <input type="hidden" name="TagIds" value="@tagId" data-tag-id="@tagId" />
                                                }
                                            }
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="block text-xs font-semibold text-text-secondary uppercase">Available Tags (Click to add)</label>
                                            <div class="flex items-center gap-2">
                                                <button type="button" onclick="openTagModal()" class="p-1 hover:bg-primary/10 rounded-full text-primary transition-colors cursor-pointer" title="Add new tag">
                                                    <span class="material-symbols-outlined text-[18px]">add_circle</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="availableTagsContainer" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1">
                                            @if (tags != null)
                                            {
                                                foreach (var tag in tags)
                                                {
                                                    bool isSelected = Model.TagIds?.Contains(tag.Id) ?? false;
                                                    <button type="button" data-tag-id="@tag.Id" data-tag-name="@tag.TagName" 
                                                            class="tag-option inline-flex items-center px-2 py-1 rounded text-xs font-medium transition-colors cursor-pointer @(isSelected ? "opacity-50 pointer-events-none bg-primary/10 text-primary" : "bg-gray-100 text-gray-600 hover:bg-primary/10 hover:text-primary")">
                                                        @tag.TagName
                                                    </button>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- Visibility -->
                                <div>
                                    <label class="block text-sm font-medium text-text-main mb-3">Visibility</label>
                                    <div class="space-y-3">
                                        <label class="flex items-center group cursor-pointer">
                                            <input type="radio" asp-for="NewsStatus" value="false" class="w-4 h-4 text-primary border-gray-300 focus:ring-primary" />
                                            <div class="ml-3 flex items-center gap-2">
                                                <span class="material-symbols-outlined text-gray-400 text-sm group-hover:text-primary transition-colors">edit_document</span>
                                                <span class="text-sm text-text-main">Draft</span>
                                            </div>
                                        </label>
                                        <label class="flex items-center group cursor-pointer">
                                            <input type="radio" asp-for="NewsStatus" value="true" class="w-4 h-4 text-primary border-gray-300 focus:ring-primary" />
                                            <div class="ml-3 flex items-center gap-2">
                                                <span class="material-symbols-outlined text-green-500 text-sm">public</span>
                                                <span class="text-sm text-text-main">Public</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions Footer -->
                            <div class="bg-gray-50 p-5 border-t border-gray-100 flex flex-col gap-3">
                                <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-2.5 px-4 rounded-lg shadow-md shadow-primary/20 transition-all flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-[20px]">save</span>
                                    Update Article
                                </button>
                                <button type="button" onclick="openPreview()" class="w-full bg-white hover:bg-gray-50 text-text-secondary border border-gray-200 font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined text-[20px]">visibility</span>
                                    Preview Article
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5 flex items-center gap-4">
                            <div class="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold">
                                @(Context.Session.GetString("AccountName")?[0].ToString().ToUpper() ?? "A")
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <p class="text-xs text-text-secondary uppercase font-semibold">Administrator</p>
                                <p class="text-sm font-bold text-text-main truncate">@Context.Session.GetString("AccountName")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="hidden fixed inset-0 z-[110] overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4 md:p-8">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePreview()"></div>
        
        <!-- Modal Content -->
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden transform transition-all flex flex-col">
            <!-- Modal Header -->
            <div class="bg-white px-6 py-4 border-b border-gray-100 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">visibility</span>
                    <h3 class="font-bold text-gray-900">Article Preview</h3>
                </div>
                <button type="button" onclick="closePreview()" class="h-8 w-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Body (Scrollable) -->
            <div class="flex-1 overflow-y-auto bg-[#fcf9f8]/50">
                <div class="max-w-4xl mx-auto p-6 md:p-12">
                    <!-- Category Badge -->
                    <div id="preview-category-container" class="mb-6 hidden">
                        <span id="preview-category" class="inline-flex items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-bold uppercase tracking-wider text-primary border border-primary/20">
                            Category
                        </span>
                    </div>
                    
                    <h1 id="preview-title" class="mb-8 text-3xl font-bold leading-tight text-gray-900 sm:text-4xl lg:text-5xl lg:leading-[1.15]">Article Title</h1>
                    
                    <!-- Author Info -->
                    <div class="flex items-center gap-6 mb-10 pb-6 border-b border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full overflow-hidden bg-gray-200">
                                <img src="https://ui-avatars.com/api/?name=@(Context.Session.GetString("AccountName") ?? "Author")&background=random" alt="Author" class="h-full w-full object-cover">
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-gray-900">@(Context.Session.GetString("AccountName") ?? "FPT Author")</span>
                                <span class="text-xs text-text-secondary">University Press</span>
                            </div>
                        </div>
                        <div class="h-4 w-px bg-gray-300"></div>
                        <div class="flex items-center gap-2 text-sm text-text-secondary">
                            <span class="material-symbols-outlined text-sm">calendar_today</span>
                            <span>@DateTime.Now.ToString("MMM dd, yyyy")</span>
                        </div>
                    </div>

                    <!-- Featured Image -->
                    <div id="preview-image-container" class="group relative mb-12 overflow-hidden rounded-2xl bg-gray-50 aspect-video flex items-center justify-center border border-gray-100 shadow-sm">
                        <img id="preview-image" src="#" alt="Preview" class="w-full h-full object-cover hidden" />
                        <div id="preview-image-placeholder" class="flex flex-col items-center text-gray-300">
                            <span class="material-symbols-outlined text-6xl">image</span>
                            <span class="text-sm mt-2">No Featured Image</span>
                        </div>
                        <div id="preview-headline-overlay" class="absolute bottom-6 left-6 right-6 bg-black/40 backdrop-blur-md px-6 py-3 rounded-xl text-white text-sm font-medium hidden">
                            Headline Preview
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
                        <p id="preview-headline" class="text-xl font-light text-gray-600 leading-relaxed border-l-4 border-primary pl-6 italic mb-10 hidden">
                            Article summary goes here...
                        </p>
                        <div id="preview-content" class="prose-headings:text-gray-900 prose-p:mb-6 prose-a:text-primary prose-a:font-semibold">
                            Article content goes here...
                        </div>
                        
                        <div id="preview-tags" class="mt-16 pt-8 border-t border-gray-100 flex flex-wrap gap-2 hidden">
                            <!-- Tags will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
                <button type="button" onclick="closePreview()" class="px-6 py-2.5 rounded-xl bg-white border border-gray-200 text-text-secondary font-bold hover:bg-gray-100 transition-all shadow-sm">
                    Close Preview
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Tag Modal -->
<div id="tagModal" class="hidden fixed inset-0 z-[100] overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/50 transition-opacity" onclick="closeTagModal()"></div>
        
        <!-- Modal Content -->
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-bold text-text-main flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">sell</span>
                    Create New Tag
                </h3>
                <button type="button" onclick="closeTagModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="newTagName" class="block text-sm font-semibold text-text-main mb-1">Tag Name <span class="text-red-500">*</span></label>
                    <input type="text" id="newTagName" class="w-full rounded-lg border-gray-200 bg-gray-50 focus:border-primary focus:ring-primary text-sm py-2.5" placeholder="e.g. Technology" />
                </div>
                <div>
                    <label for="newTagNote" class="block text-sm font-semibold text-text-main mb-1">Note (Optional)</label>
                    <textarea id="newTagNote" rows="3" class="w-full rounded-lg border-gray-200 bg-gray-50 focus:border-primary focus:ring-primary text-sm py-2.5" placeholder="Describe this tag..."></textarea>
                </div>
                <div id="tagModalError" class="hidden p-3 bg-red-50 border border-red-100 text-red-600 text-xs rounded-lg"></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
                <button type="button" onclick="closeTagModal()" class="px-4 py-2 text-sm font-medium text-text-secondary hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
                <button type="button" id="saveTagBtn" class="px-4 py-2 text-sm font-bold text-white bg-primary hover:bg-primary-dark rounded-lg shadow-md shadow-primary/20 transition-all">Create Tag</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // RTF Editor Logic
        const editor = document.getElementById('editor');
        const hiddenInput = document.getElementById('NewsContentHidden');

        function formatDoc(cmd, value = null) {
            if (value) {
                document.execCommand(cmd, false, value);
            } else {
                document.execCommand(cmd, false, null);
            }
            editor.focus();
            hiddenInput.value = editor.innerHTML;
            updateToolbar();
        }

        function updateToolbar() {
            const commands = ['bold', 'italic', 'underline'];
            commands.forEach(cmd => {
                const btn = document.getElementById(`btn-${cmd}`);
                if (btn) {
                    if (document.queryCommandState(cmd)) {
                        btn.classList.add('bg-primary/20', 'text-primary');
                        btn.classList.remove('text-text-secondary');
                    } else {
                        btn.classList.remove('bg-primary/20', 'text-primary');
                        btn.classList.add('text-text-secondary');
                    }
                }
            });
        }

        editor.addEventListener('mouseup', updateToolbar);
        editor.addEventListener('keyup', updateToolbar);
        editor.addEventListener('input', () => {
            hiddenInput.value = editor.innerHTML;
            updateToolbar();
        });

        window.createLink = function() {
            const url = prompt('Enter the link URL:');
            if (!url) return;

            const selection = window.getSelection();
            if (selection.toString().length === 0) {
                const text = prompt('Enter the text to display:');
                if (text) {
                    const link = `<a href="${url}" target="_blank">${text}</a>`;
                    document.execCommand('insertHTML', false, link);
                }
            } else {
                document.execCommand('createLink', false, url);
                const selectedElement = selection.anchorNode.parentElement;
                if (selectedElement.tagName === 'A') {
                    selectedElement.target = '_blank';
                }
            }
            hiddenInput.value = editor.innerHTML;
        }

        // Initialize editor with existing content
        if (hiddenInput.value) {
            editor.innerHTML = hiddenInput.value;
        }

        // Image Management Logic
        const urlInput = document.getElementById('imageUrlInput');
        const fileInput = document.getElementById('fileInput');
        const emptyState = document.getElementById('emptyState');
        const previewState = document.getElementById('previewState');
        const previewImg = document.getElementById('imagePreview');
        const imageContainer = document.getElementById('imageContainer');

        if (previewImg.src && previewImg.src !== window.location.href && !previewImg.src.endsWith('#')) {
            imageContainer.classList.remove('border-dashed');
            imageContainer.classList.add('border-solid', 'border-gray-100');
        }

        function showPreview(src) {
            previewImg.src = src;
            emptyState.classList.add('hidden');
            previewState.classList.remove('hidden');
            imageContainer.classList.remove('border-dashed');
            imageContainer.classList.add('border-solid', 'border-gray-100');
        }

        function clearImage() {
            previewImg.src = '#';
            emptyState.classList.remove('hidden');
            previewState.classList.add('hidden');
            imageContainer.classList.add('border-dashed');
            imageContainer.classList.remove('border-solid', 'border-gray-100');
            fileInput.value = '';
            urlInput.value = '';
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    showPreview(e.target.result);
                    urlInput.value = '';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        urlInput.addEventListener('input', function() {
            if (this.value && (this.value.startsWith('http') || this.value.startsWith('/'))) {
                showPreview(this.value);
                fileInput.value = '';
            } else if (!this.value) {
                clearImage();
            }
        });

        // Tag selection logic
        const selectedTagsContainer = document.getElementById('selectedTagsContainer');
        const hiddenInputsContainer = document.getElementById('hiddenTagsInputs');
        const tagOptions = document.querySelectorAll('.tag-option');
        const selectedTagIds = new Set();

        function createTagChip(id, name) {
            const chip = document.createElement('span');
            chip.className = 'inline-flex items-center px-2 py-1 rounded bg-primary/10 text-primary text-xs font-medium';
            chip.innerHTML = `${name} <button type="button" onclick="removeTag(${id}, this)" class="ml-1 hover:text-red-500"><span class="material-symbols-outlined text-[14px]">close</span></button>`;
            return chip;
        }

        function createHiddenInput(id) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'TagIds';
            input.value = id;
            input.setAttribute('data-tag-id', id);
            return input;
        }

        window.removeTag = function(id, btn) {
            selectedTagIds.delete(id);
            btn.parentElement.remove();
            const hiddenInput = hiddenInputsContainer.querySelector(`input[data-tag-id="${id}"]`);
            if (hiddenInput) hiddenInput.remove();
            
            const opt = document.querySelector(`.tag-option[data-tag-id="${id}"]`);
            if (opt) {
                opt.classList.remove('opacity-50', 'pointer-events-none', 'bg-primary/10', 'text-primary');
                opt.classList.add('bg-gray-100', 'text-gray-600');
            }
        };

        function addTagToSelected(btn, id, name) {
            if (!selectedTagIds.has(id)) {
                selectedTagIds.add(id);
                selectedTagsContainer.appendChild(createTagChip(id, name));
                if (!hiddenInputsContainer.querySelector(`input[data-tag-id="${id}"]`)) {
                    hiddenInputsContainer.appendChild(createHiddenInput(id));
                }
                
                if (btn) {
                    btn.classList.add('opacity-50', 'pointer-events-none', 'bg-primary/10', 'text-primary');
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                }
            }
        }

        tagOptions.forEach(opt => {
            const id = parseInt(opt.getAttribute('data-tag-id'));
            const name = opt.getAttribute('data-tag-name');
            
            // Initial state for existing tags
            if (opt.classList.contains('opacity-50')) {
                selectedTagIds.add(id);
                selectedTagsContainer.appendChild(createTagChip(id, name));
            }

            opt.addEventListener('click', function() {
                addTagToSelected(this, id, name);
            });
        });

        // Add New Tag logic
        const tagModal = document.getElementById('tagModal');
        const newTagNameInput = document.getElementById('newTagName');
        const newTagNoteInput = document.getElementById('newTagNote');
        const tagModalError = document.getElementById('tagModalError');
        const saveTagBtn = document.getElementById('saveTagBtn');
        const availableTagsContainer = document.getElementById('availableTagsContainer');

        window.openTagModal = function() {
            tagModal.classList.remove('hidden');
            tagModalError.classList.add('hidden');
            newTagNameInput.value = '';
            newTagNoteInput.value = '';
            newTagNameInput.focus();
        };

        window.closeTagModal = function() {
            tagModal.classList.add('hidden');
        };

        saveTagBtn.addEventListener('click', async function() {
            const tagName = newTagNameInput.value.trim();
            const note = newTagNoteInput.value.trim();
            
            if (!tagName) {
                showModalError('Tag name is required');
                return;
            }

            try {
                saveTagBtn.disabled = true;
                saveTagBtn.innerText = 'Creating...';
                
                const response = await fetch('/Admin/CreateTag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tagName: tagName, note: note })
                });

                if (response.ok) {
                    const newTag = await response.json();
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.setAttribute('data-tag-id', newTag.id);
                    btn.setAttribute('data-tag-name', newTag.tagName);
                    btn.className = 'tag-option inline-flex items-center px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-medium hover:bg-primary/10 hover:text-primary transition-colors cursor-pointer';
                    btn.innerText = newTag.tagName;
                    
                    btn.addEventListener('click', function() {
                        addTagToSelected(this, newTag.id, newTag.tagName);
                    });

                    availableTagsContainer.appendChild(btn);
                    addTagToSelected(btn, newTag.id, newTag.tagName);
                    closeTagModal();
                } else {
                    const error = await response.text();
                    showModalError(error);
                }
            } catch (err) {
                console.error('Error creating tag:', err);
                showModalError('Failed to create tag');
            } finally {
                saveTagBtn.disabled = false;
                saveTagBtn.innerText = 'Create Tag';
            }
        });

        function showModalError(msg) {
            tagModalError.innerText = msg;
            tagModalError.classList.remove('hidden');
        }

        newTagNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveTagBtn.click();
            }
        });

        // Preview Modal Functions
        function openPreview() {
            const title = document.querySelector('input[name="NewsTitle"]').value;
            const headline = document.querySelector('input[name="Headline"]').value;
            const content = editor.innerHTML;
            const categorySelect = document.querySelector('select[name="CategoryId"]');
            const categoryName = categorySelect.options[categorySelect.selectedIndex]?.text;
            const categoryId = categorySelect.value;
            
            // Populate Modal
            document.getElementById('preview-title').innerText = title || "Untitled Article";
            document.getElementById('preview-headline').innerText = headline;
            document.getElementById('preview-headline').classList.toggle('hidden', !headline);
            document.getElementById('preview-headline-overlay').innerText = headline || "News Preview";
            document.getElementById('preview-headline-overlay').classList.toggle('hidden', !headline);
            document.getElementById('preview-content').innerHTML = content || "<p class='text-gray-400 italic'>No content yet...</p>";
            
            // Category
            if (categoryId) {
                document.getElementById('preview-category').innerText = categoryName;
                document.getElementById('preview-category-container').classList.remove('hidden');
            } else {
                document.getElementById('preview-category-container').classList.add('hidden');
            }

            // Image
            const previewImage = document.getElementById('preview-image');
            const previewPlaceholder = document.getElementById('preview-image-placeholder');
            const currentImgSrc = document.getElementById('imagePreview').src;
            
            if (currentImgSrc && currentImgSrc !== window.location.href + '#') {
                previewImage.src = currentImgSrc;
                previewImage.classList.remove('hidden');
                previewPlaceholder.classList.add('hidden');
            } else {
                previewImage.classList.add('hidden');
                previewPlaceholder.classList.remove('hidden');
            }

            // Tags
            const tagsContainer = document.getElementById('preview-tags');
            tagsContainer.innerHTML = '';
            const selectedChips = selectedTagsContainer.querySelectorAll('span');
            if (selectedChips.length > 0) {
                selectedChips.forEach(chip => {
                    const tagName = chip.innerText.replace('close', '').trim();
                    const tagBadge = document.createElement('span');
                    tagBadge.className = 'px-3 py-1.5 bg-gray-50 text-gray-600 text-sm font-medium rounded-lg border border-gray-100';
                    tagBadge.innerText = '#' + tagName;
                    tagsContainer.appendChild(tagBadge);
                });
                tagsContainer.classList.remove('hidden');
            } else {
                tagsContainer.classList.add('hidden');
            }

            document.getElementById('previewModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scroll
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore scroll
        }
    </script>
}
